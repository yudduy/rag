"use strict";exports.id=463,exports.ids=[463],exports.modules={89228:(e,t,r)=>{r.d(t,{HT:()=>o,a4:()=>c,I8:()=>d,w7:()=>u});var n=r(75032),s=r(81218),a=r(45807),i=r(21080);let{handlers:{GET:o,POST:c},auth:d,signIn:l,signOut:u}=(0,s.ZP)({pages:{signIn:"/login",newUser:"/"},providers:[],callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user,n=t.pathname.startsWith("/"),s=t.pathname.startsWith("/register"),a=t.pathname.startsWith("/login");return r&&(a||s)?Response.redirect(new URL("/",t)):!!s||!!a||(n?!!r:!r||Response.redirect(new URL("/",t)))}},providers:[(0,a.Z)({credentials:{},async authorize({email:e,password:t}){if(!e||!t)return null;let r=await (0,i.PR)(e);if(0===r.length)return null;let s=r[0];return s.password&&await (0,n.qu)(t,s.password)?s:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}})},21080:(e,t,r)=>{r.d(t,{OE:()=>D,Rr:()=>T,LT:()=>v,g6:()=>L,T:()=>P,AN:()=>R,cQ:()=>k,Qv:()=>S,PR:()=>A,l_:()=>I,xd:()=>C,mU:()=>U}),r(75032);var n=r(40986),s=r(6931),a=r(19975),i=r(32219),o=r(49141),c=r(85332),d=r(45220),l=r(17714),u=r(33866),m=r(62746),h=r(80346),p=r(27883),g=r(78367),f=r(73977);let w=(0,o.af)("User",{id:(0,c.Vj)("id").primaryKey().notNull().defaultRandom(),email:(0,d.L7)("email",{length:64}).notNull(),password:(0,d.L7)("password",{length:128})},e=>({uniqueEmail:(0,l.Tw)().on(e.email)})),y=(0,o.af)("Chat",{id:(0,c.Vj)("id").primaryKey().notNull().defaultRandom(),createdAt:(0,u.AB)("createdAt").notNull(),messages:(0,m.AV)("messages").notNull(),userId:(0,c.Vj)("userId").notNull().references(()=>w.id)}),_=(0,o.af)("Reservation",{id:(0,c.Vj)("id").primaryKey().notNull().defaultRandom(),createdAt:(0,u.AB)("createdAt").notNull(),details:(0,m.AV)("details").notNull(),hasCompletedPayment:(0,h.O7)("hasCompletedPayment").notNull().default(!1),userId:(0,c.Vj)("userId").notNull().references(()=>w.id)}),x=(0,o.af)("Document",{id:(0,c.Vj)("id").primaryKey().notNull().defaultRandom(),filename:(0,d.L7)("filename",{length:255}).notNull(),originalName:(0,d.L7)("originalName",{length:255}).notNull(),fileType:(0,d.L7)("fileType",{length:50}).notNull(),fileSize:(0,p._L)("fileSize").notNull(),content:(0,g.fL)("content").notNull(),status:(0,d.L7)("status",{length:20}).notNull().default("indexed"),chunkCount:(0,p._L)("chunkCount").notNull().default(0),createdAt:(0,u.AB)("createdAt").notNull().default((0,f.i6)`CURRENT_TIMESTAMP`),updatedAt:(0,u.AB)("updatedAt").notNull().default((0,f.i6)`CURRENT_TIMESTAMP`),userId:(0,c.Vj)("userId").notNull().references(()=>w.id,{onDelete:"cascade"})}),N=process.env.POSTGRES_URL?(()=>{let e=new URL(process.env.POSTGRES_URL);return e.searchParams.set("sslmode","require"),e.toString()})():"postgres://dummy:dummy@localhost:5432/dummy",E=(0,i.Z)(N,{max:1,transform:process.env.POSTGRES_URL?i.Z.camel:void 0}),b=(0,a.t)(E);async function A(e){try{return await b.select().from(w).where((0,n.eq)(w.email,e))}catch(e){throw console.error("Failed to get user from database"),e}}async function I({id:e,messages:t,userId:r}){try{if((await b.select().from(y).where((0,n.eq)(y.id,e))).length>0)return await b.update(y).set({messages:JSON.stringify(t)}).where((0,n.eq)(y.id,e));return await b.insert(y).values({id:e,createdAt:new Date,messages:JSON.stringify(t),userId:r})}catch(e){throw console.error("Failed to save chat in database"),e}}async function v({id:e}){try{return await b.delete(y).where((0,n.eq)(y.id,e))}catch(e){throw console.error("Failed to delete chat by id from database"),e}}async function R({id:e}){try{return await b.select().from(y).where((0,n.eq)(y.userId,e)).orderBy((0,s.C)(y.createdAt))}catch(e){throw console.error("Failed to get chats by user from database"),e}}async function P({id:e}){try{let[t]=await b.select().from(y).where((0,n.eq)(y.id,e));return t}catch(e){throw console.error("Failed to get chat by id from database"),e}}async function T({id:e,userId:t,details:r}){return await b.insert(_).values({id:e,createdAt:new Date,userId:t,hasCompletedPayment:!1,details:JSON.stringify(r)})}async function S({id:e}){let[t]=await b.select().from(_).where((0,n.eq)(_.id,e));return t}async function U({id:e,hasCompletedPayment:t}){return await b.update(_).set({hasCompletedPayment:t}).where((0,n.eq)(_.id,e))}async function D({filename:e,originalName:t,fileType:r,fileSize:n,content:s,userId:a}){try{let[i]=await b.insert(x).values({filename:e,originalName:t,fileType:r,fileSize:n,content:s,userId:a,status:"indexed",chunkCount:0}).returning();return i}catch(e){throw console.error("Failed to create document in database"),e}}async function k({id:e}){try{let[t]=await b.select().from(x).where((0,n.eq)(x.id,e));return t}catch(e){throw console.error("Failed to get document by id from database"),e}}async function C({id:e,chunkCount:t}){try{return await b.update(x).set({chunkCount:t,updatedAt:new Date}).where((0,n.eq)(x.id,e))}catch(e){throw console.error("Failed to update document chunk count"),e}}async function L({id:e}){try{return await b.delete(x).where((0,n.eq)(x.id,e))}catch(e){throw console.error("Failed to delete document by id from database"),e}}},72724:(e,t,r)=>{r.d(t,{vd:()=>m});var n=r(41662),s=r(84934),a=r(37080),i=r(9630);class o{constructor(e={}){this.hf=new i.LF(e.apiKey||process.env.HUGGINGFACE_API_KEY),this.model=e.model||"sentence-transformers/all-MiniLM-L6-v2",this.maxRetries=e.maxRetries||3,this.retryDelay=e.retryDelay||1e3,process.env.HUGGINGFACE_API_KEY||e.apiKey||console.warn("No HuggingFace API key provided. Using public inference endpoint with rate limits.")}async embedText(e){if(!e||0===e.trim().length)throw Error("Text cannot be empty");let t=this.truncateText(e,512);for(let e=1;e<=this.maxRetries;e++)try{let e;let r=await this.hf.featureExtraction({model:this.model,inputs:t});if(Array.isArray(r))e=Array.isArray(r[0])?r[0]:r;else throw Error("Unexpected response format from HuggingFace API");if(!e||0===e.length)throw Error("Empty embedding returned");return e}catch(t){if(console.error(`HuggingFace API attempt ${e} failed:`,t),e===this.maxRetries)throw Error(`Failed to generate embedding after ${this.maxRetries} attempts: ${t instanceof Error?t.message:"Unknown error"}`);await this.sleep(this.retryDelay*Math.pow(2,e-1))}throw Error("Max retries exceeded")}async embedTexts(e){if(!e||0===e.length)return[];let t=[];for(let r=0;r<e.length;r+=10){let n=e.slice(r,r+10),s=n.map(e=>this.embedText(e));try{let e=await Promise.all(s);t.push(...e)}catch(e){throw console.error(`Batch processing failed for texts ${r}-${r+n.length}:`,e),e}r+10<e.length&&await this.sleep(200)}return t}getDimensions(){switch(this.model){case"sentence-transformers/all-MiniLM-L6-v2":default:return 384;case"sentence-transformers/all-mpnet-base-v2":case"sentence-transformers/all-distilroberta-v1":return 768}}getModelName(){return this.model}truncateText(e,t){let r=4*t;if(e.length<=r)return e;let n=e.substring(0,r),s=n.lastIndexOf(" ");return s>.8*r?n.substring(0,s):n}sleep(e){return new Promise(t=>setTimeout(t,e))}async test(){try{let e=await this.embedText("This is a test sentence for embedding generation.");return{success:!0,dimensions:e.length}}catch(e){return{success:!1,dimensions:0,error:e instanceof Error?e.message:"Unknown error"}}}}let c={chunk_size:parseInt(process.env.RAG_CHUNK_SIZE||"1000"),chunk_overlap:parseInt(process.env.RAG_CHUNK_OVERLAP||"200"),max_retrieval_docs:parseInt(process.env.RAG_MAX_DOCS||"5"),similarity_threshold:parseFloat(process.env.RAG_SIMILARITY_THRESHOLD||"0.7"),query_expansion_enabled:"true"===process.env.RAG_QUERY_EXPANSION,reranking_enabled:"true"===process.env.RAG_RERANKING},d=a.Ry({filename:a.Z_().min(1),content:a.Z_().min(1),file_type:a.Km(["txt","md","pdf","docx"]),user_id:a.Z_().uuid()});class l{constructor(){if(this.index=null,!process.env.PINECONE_API_KEY)throw Error("PINECONE_API_KEY is required for RAG functionality");this.pinecone=new n.Pinecone({apiKey:process.env.PINECONE_API_KEY}),this.embeddings=new o,this.indexName=process.env.PINECONE_INDEX_NAME||"rag-documents",this.textSplitter=new s.s9({chunkSize:c.chunk_size,chunkOverlap:c.chunk_overlap,separators:["\n\n","\n",". "," ",""]}),this.initializeIndex()}async initializeIndex(){try{let e=await this.pinecone.listIndexes();e.indexes?.some(e=>e.name===this.indexName)||(console.log(`Creating Pinecone index: ${this.indexName}`),await this.pinecone.createIndex({name:this.indexName,dimension:this.embeddings.getDimensions(),metric:"cosine",spec:{serverless:{cloud:"aws",region:"us-east-1"}}}),console.log("Waiting for index to be ready..."),await this.waitForIndexReady()),this.index=this.pinecone.index(this.indexName),console.log(`Connected to Pinecone index: ${this.indexName}`)}catch(e){throw console.error("Error initializing Pinecone index:",e),e}}async waitForIndexReady(e=6e4){let t=Date.now();for(;Date.now()-t<e;){try{let e=await this.pinecone.describeIndex(this.indexName);if(e.status?.ready)return}catch(e){}await new Promise(e=>setTimeout(e,2e3))}throw Error(`Index ${this.indexName} did not become ready within ${e}ms`)}getUserNamespace(e){return`user_${e}`}async indexDocument(e,t,r,n){try{let s=d.safeParse({filename:e,content:t,file_type:r,user_id:n});if(!s.success)return{success:!1,chunks:0,error:`Validation failed: ${s.error.message}`};this.index||await this.initializeIndex();let a=await this.textSplitter.createDocuments([t],[{source:e,file_type:r,user_id:n,upload_date:new Date().toISOString()}]),i=a.map(e=>e.pageContent),o=await this.embeddings.embedTexts(i),c=a.map((t,s)=>({id:`${n}_${e}_${s}`,values:o[s],metadata:{content:t.pageContent,source:e,chunk_index:s,total_chunks:a.length,file_type:r,user_id:n,upload_date:new Date().toISOString()}})),l=this.getUserNamespace(n);return await this.index.namespace(l).upsert(c),{success:!0,chunks:c.length}}catch(e){return console.error("Error indexing document:",e),{success:!1,chunks:0,error:e instanceof Error?e.message:"Unknown error"}}}expandQuery(e){if(!c.query_expansion_enabled)return[e];let t=[e],r=e.toLowerCase().split(/\s+/);return e.includes("what")||e.includes("how")||e.includes("why")||(r.some(e=>["define","definition","meaning"].includes(e))&&t.push(`What is ${e}?`),r.some(e=>["process","steps","procedure"].includes(e))&&t.push(`How to ${e}?`)),t.slice(0,3)}async retrieveDocuments(e,t,r={}){this.index||await this.initializeIndex();try{let n=r.maxDocs||c.max_retrieval_docs,s=r.threshold||c.similarity_threshold,a=await this.embeddings.embedText(e),i=this.getUserNamespace(t),o=await this.index.namespace(i).query({vector:a,topK:n,includeMetadata:!0,includeValues:!1});return(o.matches?.filter(e=>{let t=e.score||0,r=e.metadata||{};return t>=s&&!r.deleted}).map(e=>({content:e.metadata?.content||"",source:e.metadata?.source||"",relevance_score:e.score||0,metadata:e.metadata||{}}))||[]).sort((e,t)=>t.relevance_score-e.relevance_score)}catch(e){return console.error("Error retrieving documents:",e),[]}}async getUserDocuments(e){this.index||await this.initializeIndex();try{let t=this.getUserNamespace(e),r=await this.index.namespace(t).query({vector:Array(this.embeddings.getDimensions()).fill(0),topK:1e4,includeMetadata:!0,includeValues:!1}),n=new Map;return r.matches?.forEach(e=>{let t=e.metadata;if(t&&!t.deleted){let e=t.source;n.has(e)||n.set(e,{filename:e,chunks:0,file_type:t.file_type,upload_date:t.upload_date});let r=n.get(e);r.chunks++}}),Array.from(n.values()).sort((e,t)=>new Date(t.upload_date).getTime()-new Date(e.upload_date).getTime())}catch(e){return console.error("Error getting user documents:",e),[]}}async deleteDocument(e,t){this.index||await this.initializeIndex();try{let r=this.getUserNamespace(t),n=await this.index.namespace(r).query({vector:Array(this.embeddings.getDimensions()).fill(0),topK:1e4,includeMetadata:!0,includeValues:!1,filter:{source:e,user_id:t}}),s=n.matches?.map(e=>e.id)||[];if(0===s.length)return!1;return await this.index.namespace(r).deleteMany(s),!0}catch(e){return console.error("Error deleting document:",e),!1}}async getStatus(){try{let e=this.index?await this.index.describeIndexStats():null;return{pinecone_connected:!!this.index,index_name:this.indexName,embedding_model:this.embeddings.getModelName(),embedding_dimensions:this.embeddings.getDimensions(),total_vectors:e?.totalVectorCount||0,namespaces:e?.namespaces||{},config:c}}catch(e){return{pinecone_connected:!1,error:e instanceof Error?e.message:"Unknown error",config:c}}}async testPipeline(){try{let e=await this.embeddings.test();if(!e.success)return{success:!1,embeddings_test:e,error:"Embeddings test failed"};let t=await this.getStatus();return{success:t.pinecone_connected,embeddings_test:e,pinecone_test:t}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}}let u=null;function m(){return u||(u=new l),u}}};