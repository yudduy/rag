"use strict";(()=>{var e={};e.id=737,e.ids=[737],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32307:e=>{e.exports=require("next/dist/server/app-render/prerender-async-storage.external.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},41808:e=>{e.exports=require("net")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},22037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},41556:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>l});var n=r(38728),s=r(64006),o=r(64615),i=r(89228),u=r(21080);async function l(){let e=await (0,i.I8)();if(!e||!e.user||!e.user.id)return Response.json("Unauthorized!",{status:401});let t=await (0,u.AN)({id:e.user.id});return Response.json(t)}let d=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/(chat)/api/history/route",pathname:"/api/history",filename:"route",bundlePath:"app/(chat)/api/history/route"},resolvedPagePath:"/Users/duy/Documents/build/rag/app/(chat)/api/history/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,prerenderAsyncStorage:h,serverHooks:m}=d;function f(){return(0,o.patchFetch)({staticGenerationAsyncStorage:p,requestAsyncStorage:c,prerenderAsyncStorage:h})}},89228:(e,t,r)=>{r.d(t,{HT:()=>i,a4:()=>u,I8:()=>l,w7:()=>c});var a=r(75032),n=r(81218),s=r(45807),o=r(21080);let{handlers:{GET:i,POST:u},auth:l,signIn:d,signOut:c}=(0,n.ZP)({pages:{signIn:"/login",newUser:"/"},providers:[],callbacks:{authorized({auth:e,request:{nextUrl:t}}){let r=!!e?.user,a=t.pathname.startsWith("/"),n=t.pathname.startsWith("/register"),s=t.pathname.startsWith("/login");return r&&(s||n)?Response.redirect(new URL("/",t)):!!n||!!s||(a?!!r:!r||Response.redirect(new URL("/",t)))}},providers:[(0,s.Z)({credentials:{},async authorize({email:e,password:t}){if(!e||!t)return null;let r=await (0,o.PR)(e);if(0===r.length)return null;let n=r[0];return n.password&&await (0,a.qu)(t,n.password)?n:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}})},21080:(e,t,r)=>{r.d(t,{OE:()=>L,LT:()=>b,g6:()=>U,T:()=>T,AN:()=>j,cQ:()=>S,te:()=>P,PR:()=>A,l_:()=>v,xd:()=>I}),r(75032);var a=r(40986),n=r(6931),s=r(19975),o=r(32219),i=r(49141),u=r(85332),l=r(45220),d=r(17714),c=r(33866),p=r(62746),h=r(80346),m=r(27883),f=r(78367),y=r(73977);let w=(0,i.af)("User",{id:(0,u.Vj)("id").primaryKey().notNull().defaultRandom(),email:(0,l.L7)("email",{length:64}).notNull(),password:(0,l.L7)("password",{length:128})},e=>({uniqueEmail:(0,d.Tw)().on(e.email)})),g=(0,i.af)("Chat",{id:(0,u.Vj)("id").primaryKey().notNull().defaultRandom(),createdAt:(0,c.AB)("createdAt").notNull(),messages:(0,p.AV)("messages").notNull(),userId:(0,u.Vj)("userId").notNull().references(()=>w.id)});(0,i.af)("Reservation",{id:(0,u.Vj)("id").primaryKey().notNull().defaultRandom(),createdAt:(0,c.AB)("createdAt").notNull(),details:(0,p.AV)("details").notNull(),hasCompletedPayment:(0,h.O7)("hasCompletedPayment").notNull().default(!1),userId:(0,u.Vj)("userId").notNull().references(()=>w.id)});let x=(0,i.af)("Document",{id:(0,u.Vj)("id").primaryKey().notNull().defaultRandom(),filename:(0,l.L7)("filename",{length:255}).notNull(),originalName:(0,l.L7)("originalName",{length:255}).notNull(),fileType:(0,l.L7)("fileType",{length:50}).notNull(),fileSize:(0,m._L)("fileSize").notNull(),content:(0,f.fL)("content").notNull(),status:(0,l.L7)("status",{length:20}).notNull().default("indexed"),chunkCount:(0,m._L)("chunkCount").notNull().default(0),createdAt:(0,c.AB)("createdAt").notNull().default((0,y.i6)`CURRENT_TIMESTAMP`),updatedAt:(0,c.AB)("updatedAt").notNull().default((0,y.i6)`CURRENT_TIMESTAMP`),userId:(0,u.Vj)("userId").notNull().references(()=>w.id,{onDelete:"cascade"})}),q=process.env.POSTGRES_URL?(()=>{let e=new URL(process.env.POSTGRES_URL);return e.searchParams.set("sslmode","require"),e.toString()})():"postgres://dummy:dummy@localhost:5432/dummy",N=(0,o.Z)(q,{max:1,transform:process.env.POSTGRES_URL?o.Z.camel:void 0}),R=(0,s.t)(N);async function A(e){try{return await R.select().from(w).where((0,a.eq)(w.email,e))}catch(e){throw console.error("Failed to get user from database"),e}}async function v({id:e,messages:t,userId:r}){try{if((await R.select().from(g).where((0,a.eq)(g.id,e))).length>0)return await R.update(g).set({messages:JSON.stringify(t)}).where((0,a.eq)(g.id,e));return await R.insert(g).values({id:e,createdAt:new Date,messages:JSON.stringify(t),userId:r})}catch(e){throw console.error("Failed to save chat in database"),e}}async function b({id:e}){try{return await R.delete(g).where((0,a.eq)(g.id,e))}catch(e){throw console.error("Failed to delete chat by id from database"),e}}async function j({id:e}){try{return await R.select().from(g).where((0,a.eq)(g.userId,e)).orderBy((0,n.C)(g.createdAt))}catch(e){throw console.error("Failed to get chats by user from database"),e}}async function T({id:e}){try{let[t]=await R.select().from(g).where((0,a.eq)(g.id,e));return t}catch(e){throw console.error("Failed to get chat by id from database"),e}}async function L({filename:e,originalName:t,fileType:r,fileSize:a,content:n,userId:s}){try{let[o]=await R.insert(x).values({filename:e,originalName:t,fileType:r,fileSize:a,content:n,userId:s,status:"indexed",chunkCount:0}).returning();return o}catch(e){throw console.error("Failed to create document in database"),e}}async function P({userId:e}){try{return await R.select().from(x).where((0,a.eq)(x.userId,e)).orderBy((0,n.C)(x.createdAt))}catch(e){throw console.error("Failed to get documents by user from database:",e),e}}async function S({id:e}){try{let[t]=await R.select().from(x).where((0,a.eq)(x.id,e));return t}catch(e){throw console.error("Failed to get document by id from database"),e}}async function I({id:e,chunkCount:t}){try{return await R.update(x).set({chunkCount:t,updatedAt:new Date}).where((0,a.eq)(x.id,e))}catch(e){throw console.error("Failed to update document chunk count"),e}}async function U({id:e}){try{return await R.delete(x).where((0,a.eq)(x.id,e))}catch(e){throw console.error("Failed to delete document by id from database"),e}}},38728:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[615,503],()=>r(41556));module.exports=a})();