"use strict";(()=>{var e={};e.id=412,e.ids=[412],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32307:e=>{e.exports=require("next/dist/server/app-render/prerender-async-storage.external.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},41808:e=>{e.exports=require("net")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},84492:e=>{e.exports=require("node:stream")},47261:e=>{e.exports=require("node:util")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},4074:e=>{e.exports=require("perf_hooks")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},47658:(e,t,n)=>{n.r(t),n.d(t,{patchFetch:()=>j,requestAsyncStorage:()=>U,routeModule:()=>_,serverHooks:()=>$,staticGenerationAsyncStorage:()=>G});var s={};n.r(s),n.d(s,{DELETE:()=>q,POST:()=>O});var o=n(38728),r=n(64006),a=n(64615),i=n(30006),l=n(37080),c=n(92031),u=n(55203);function d(e){if("boolean"==typeof e)return{type:"boolean",properties:{}};let{type:t,description:n,required:s,properties:o,items:r,allOf:a,anyOf:i,oneOf:l,format:c,const:u,minLength:p}=e,m={};return n&&(m.description=n),s&&(m.required=s),c&&(m.format=c),void 0!==u&&(m.enum=[u]),t&&(Array.isArray(t)?t.includes("null")?(m.type=t.filter(e=>"null"!==e)[0],m.nullable=!0):m.type=t:"null"===t?m.type="null":m.type=t),o&&(m.properties=Object.entries(o).reduce((e,[t,n])=>(e[t]=d(n),e),{})),r&&(m.items=Array.isArray(r)?r.map(d):d(r)),a&&(m.allOf=a.map(d)),i&&(m.anyOf=i.map(d)),l&&(m.oneOf=l.map(d)),void 0!==p&&(m.minLength=p),m}function p(e){return e.includes("/")?e:`models/${e}`}var m=l.Ry({error:l.Ry({code:l.Rx().nullable(),message:l.Z_(),status:l.Z_()})}),g=(0,c.Sq)({errorSchema:m,errorToMessage:e=>e.error.message});function h({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"RECITATION":case"SAFETY":return"content-filter";case"FINISH_REASON_UNSPECIFIED":case"OTHER":return"other";default:return"unknown"}}var f=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1,this.modelId=e,this.settings=t,this.config=n}get supportsObjectGeneration(){return!1!==this.settings.structuredOutputs}get provider(){return this.config.provider}async getArgs({mode:e,prompt:t,maxTokens:n,temperature:s,topP:o,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:p,seed:m}){var g;let h=e.type,f=[];null!=a&&f.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&f.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=m&&f.push({type:"unsupported-setting",setting:"seed"});let y={topK:null!=r?r:this.settings.topK,maxOutputTokens:n,temperature:s,topP:o,stopSequences:l,responseMimeType:(null==p?void 0:p.type)==="json"?"application/json":void 0,responseSchema:(null==p?void 0:p.type)==="json"&&null!=p.schema&&this.supportsObjectGeneration?d(p.schema):void 0},{contents:v,systemInstruction:x}=function(e){var t;let n=[],s=[],o=!0;for(let{role:r,content:a}of e)switch(r){case"system":if(!o)throw new u.A_({functionality:"system messages are only supported at the beginning of the conversation"});n.push({text:a});break;case"user":{o=!1;let e=[];for(let n of a)switch(n.type){case"text":e.push({text:n.text});break;case"image":if(n.image instanceof URL)throw new u.A_({functionality:"Image URLs in user messages"});e.push({inlineData:{mimeType:null!=(t=n.mimeType)?t:"image/jpeg",data:(0,c.k0)(n.image)}});break;case"file":if(n.data instanceof URL)throw new u.A_({functionality:"File URLs in user messages"});e.push({inlineData:{mimeType:n.mimeType,data:n.data}})}s.push({role:"user",parts:e});break}case"assistant":o=!1,s.push({role:"model",parts:a.map(e=>{switch(e.type){case"text":return 0===e.text.length?void 0:{text:e.text};case"tool-call":return{functionCall:{name:e.toolName,args:e.args}}}}).filter(e=>void 0!==e)});break;case"tool":o=!1,s.push({role:"user",parts:a.map(e=>({functionResponse:{name:e.toolName,response:e.result}}))});break;default:throw Error(`Unsupported role: ${r}`)}return{systemInstruction:n.length>0?{parts:n}:void 0,contents:s}}(t);switch(h){case"regular":return{args:{generationConfig:y,contents:v,systemInstruction:x,safetySettings:this.settings.safetySettings,...function(e){var t;let n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0;if(null==n)return{tools:void 0,toolConfig:void 0};let s={functionDeclarations:n.map(e=>{var t;return{name:e.name,description:null!=(t=e.description)?t:"",parameters:d(e.parameters)}})},o=e.toolChoice;if(null==o)return{tools:s,toolConfig:void 0};let r=o.type;switch(r){case"auto":return{tools:s,toolConfig:{functionCallingConfig:{mode:"AUTO"}}};case"none":return{tools:s,toolConfig:{functionCallingConfig:{mode:"NONE"}}};case"required":return{tools:s,toolConfig:{functionCallingConfig:{mode:"ANY"}}};case"tool":return{tools:s,toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[o.toolName]}}};default:throw Error(`Unsupported tool choice type: ${r}`)}}(e),cachedContent:this.settings.cachedContent},warnings:f};case"object-json":return{args:{generationConfig:{...y,responseMimeType:"application/json",responseSchema:null!=e.schema&&this.supportsObjectGeneration?d(e.schema):void 0},contents:v,systemInstruction:x,safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};case"object-tool":return{args:{generationConfig:y,contents:v,tools:{functionDeclarations:[{name:e.tool.name,description:null!=(g=e.tool.description)?g:"",parameters:d(e.tool.parameters)}]},toolConfig:{functionCallingConfig:{mode:"ANY"}},safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};default:throw Error(`Unsupported type: ${h}`)}}async doGenerate(e){var t,n;let{args:s,warnings:o}=await this.getArgs(e),{responseHeaders:r,value:a}=await (0,c.A8)({url:`${this.config.baseURL}/${p(this.modelId)}:generateContent`,headers:(0,c.NF)(this.config.headers(),e.headers),body:s,failedResponseHandler:g,successfulResponseHandler:(0,c.tc)(b),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:i,...l}=s,u=a.candidates[0],d=y({parts:u.content.parts,generateId:this.config.generateId}),m=a.usageMetadata;return{text:v(u.content.parts),toolCalls:d,finishReason:h({finishReason:u.finishReason,hasToolCalls:null!=d&&d.length>0}),usage:{promptTokens:null!=(t=null==m?void 0:m.promptTokenCount)?t:NaN,completionTokens:null!=(n=null==m?void 0:m.candidatesTokenCount)?n:NaN},rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:r},warnings:o}}async doStream(e){let{args:t,warnings:n}=await this.getArgs(e),{responseHeaders:s,value:o}=await (0,c.A8)({url:`${this.config.baseURL}/${p(this.modelId)}:streamGenerateContent?alt=sse`,headers:(0,c.NF)(this.config.headers(),e.headers),body:t,failedResponseHandler:g,successfulResponseHandler:(0,c.cP)(w),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:r,...a}=t,i="unknown",l={promptTokens:Number.NaN,completionTokens:Number.NaN},u=this.config.generateId,d=!1;return{stream:o.pipeThrough(new TransformStream({transform(e,t){var n,s;if(!e.success){t.enqueue({type:"error",error:e.error});return}let o=e.value,r=o.candidates[0];(null==r?void 0:r.finishReason)!=null&&(i=h({finishReason:r.finishReason,hasToolCalls:d}));let a=o.usageMetadata;null!=a&&(l={promptTokens:null!=(n=a.promptTokenCount)?n:NaN,completionTokens:null!=(s=a.candidatesTokenCount)?s:NaN});let c=r.content;if(null==c)return;let p=v(c.parts);null!=p&&t.enqueue({type:"text-delta",textDelta:p});let m=y({parts:c.parts,generateId:u});if(null!=m)for(let e of m)t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:e.args}),t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args}),d=!0},flush(e){e.enqueue({type:"finish",finishReason:i,usage:l})}})),rawCall:{rawPrompt:r,rawSettings:a},rawResponse:{headers:s},warnings:n}}};function y({parts:e,generateId:t}){let n=e.filter(e=>"functionCall"in e);return 0===n.length?void 0:n.map(e=>({toolCallType:"function",toolCallId:t(),toolName:e.functionCall.name,args:JSON.stringify(e.functionCall.args)}))}function v(e){let t=e.filter(e=>"text"in e);return 0===t.length?void 0:t.map(e=>e.text).join("")}var x=l.Ry({role:l.Z_(),parts:l.IX(l.G0([l.Ry({text:l.Z_()}),l.Ry({functionCall:l.Ry({name:l.Z_(),args:l._4()})})]))}),b=l.Ry({candidates:l.IX(l.Ry({content:x,finishReason:l.Z_().optional()})),usageMetadata:l.Ry({promptTokenCount:l.Rx(),candidatesTokenCount:l.Rx().nullish(),totalTokenCount:l.Rx()}).optional()}),w=l.Ry({candidates:l.IX(l.Ry({content:x.optional(),finishReason:l.Z_().optional()})),usageMetadata:l.Ry({promptTokenCount:l.Rx(),candidatesTokenCount:l.Rx().nullish(),totalTokenCount:l.Rx()}).optional()}),R=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){return 2048}get supportsParallelCalls(){return!0}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new u.ON({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let{responseHeaders:s,value:o}=await (0,c.A8)({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:(0,c.NF)(this.config.headers(),t),body:{requests:e.map(e=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:e}]},outputDimensionality:this.settings.outputDimensionality}))},failedResponseHandler:g,successfulResponseHandler:(0,c.tc)(I),abortSignal:n,fetch:this.config.fetch});return{embeddings:o.embeddings.map(e=>e.values),usage:void 0,rawResponse:{headers:s}}}},I=l.Ry({embeddings:l.IX(l.Ry({values:l.IX(l.Rx())}))}),C=function(e={}){var t,n;let s=null!=(n=(0,c.QT)(null!=(t=e.baseURL)?t:e.baseUrl))?n:"https://generativelanguage.googleapis.com/v1beta",o=()=>({"x-goog-api-key":(0,c.pd)({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers}),r=(t,n={})=>{var r;return new f(t,n,{provider:"google.generative-ai",baseURL:s,headers:o,generateId:null!=(r=e.generateId)?r:c.Ox,fetch:e.fetch})},a=(t,n={})=>new R(t,n,{provider:"google.generative-ai",baseURL:s,headers:o,fetch:e.fetch}),i=function(e,t){if(new.target)throw Error("The Google Generative AI model function cannot be called with the new keyword.");return r(e,t)};return i.languageModel=r,i.chat=r,i.generativeAI=r,i.embedding=a,i.textEmbedding=a,i.textEmbeddingModel=a,i}();let S={};(0,i.bm)({model:C("gemini-1.5-pro-002"),middleware:S});let T=(0,i.bm)({model:C("gemini-1.5-flash-002"),middleware:S});var D=n(89228),E=n(21080),A=n(72724),N=n(87930),k=n(15914);async function O(e){let{id:t,messages:n}=await e.json(),s=await (0,D.I8)();if(!s)return new Response(JSON.stringify({error:"Authentication required",errorDetails:{type:"auth",title:"Authentication Required",message:"Please log in to use the chat feature",details:{code:"AUTH_REQUIRED",timestamp:new Date().toISOString(),endpoint:"/api/chat"},suggestions:["Please log in to your account","If you're already logged in, try refreshing the page","Check if your session has expired"],canRetry:!1,canReport:!1}}),{status:401,headers:{"Content-Type":"application/json"}});let o=(0,i.BZ)(n).filter(e=>e.content.length>0);if(0===o.length)return console.error("No valid messages after filtering",{originalMessages:n}),new Response(JSON.stringify({error:"No valid messages provided",errorDetails:{type:"validation",title:"Invalid Message Content",message:"No valid messages were provided for processing. Please ensure your message contains text content.",details:{code:"EMPTY_MESSAGES",timestamp:new Date().toISOString(),endpoint:"/api/chat",userId:s.user?.id},suggestions:["Try typing a text message","Ensure your message isn't empty","If uploading documents, wait for indexing to complete first"],technicalInfo:[{label:"Original Messages",value:n.length.toString()},{label:"Filtered Messages",value:o.length.toString()}],canRetry:!0,canReport:!0}}),{status:400,headers:{"Content-Type":"application/json"}});let r=n.filter(e=>"user"===e.role).pop()?.content||"",a=(0,N.DO)(),c=null;s.user?.id&&r&&(c=k.H.createSession(a,s.user.id,r));let u="",d=[];if(s.user?.id&&r)try{let e=(0,A.vd)(),t=e.getEmbeddingModelInfo();k.H.updateQueryEmbeddingStep(a,"processing",{originalQuery:r,processedQuery:r,embeddingModel:t.modelName,embeddingDimensions:t.dimensions}),Date.now();let n=await e.generateEmbedding(r);Date.now(),k.H.updateQueryEmbeddingStep(a,"completed",{originalQuery:r,processedQuery:r,embeddingModel:t.modelName,embeddingDimensions:t.dimensions,embeddingVector:n.slice(0,8),embeddingPreview:n.slice(0,8).map(e=>e.toFixed(4)).join(", ")}),k.H.updateDocumentRetrievalStep(a,"processing",{searchQuery:r,namespace:`user-${s.user.id}`,searchParams:{topK:5,threshold:.1}}),Date.now();let o=await e.retrieveDocuments(r,s.user.id,{maxDocs:5,threshold:.1});Date.now(),console.log(`📄 Retrieved ${o.length} documents:`,o.map(e=>({source:e.source,score:e.relevance_score,contentLength:e.content.length}))),k.H.updateDocumentRetrievalStep(a,"completed",{searchQuery:r,namespace:`user-${s.user.id}`,searchParams:{topK:5,threshold:.1},totalResults:o.length,filteredResults:o.length,documents:o.map(e=>({id:e.chunkId||(0,N.DO)(),source:e.source,content:e.content,snippet:e.snippet,relevanceScore:e.relevance_score,metadata:{page:e.page,chunkId:e.chunkId||(0,N.DO)(),fileType:e.metadata?.file_type||"unknown",...e.metadata}}))}),o.length>0?(k.H.updateContextAssemblyStep(a,"processing",{selectedDocuments:o.map(e=>({id:e.chunkId||(0,N.DO)(),source:e.source,content:e.content,snippet:e.snippet,relevanceScore:e.relevance_score,metadata:{page:e.page,chunkId:e.chunkId||(0,N.DO)(),fileType:e.metadata?.file_type||"unknown",...e.metadata}})),assemblyStrategy:"Relevance-based concatenation"}),Date.now(),d=o,u=o.map((e,t)=>`[Source ${t+1}: ${e.source}]
${e.content}`).join("\n\n"),Date.now(),k.H.updateContextAssemblyStep(a,"completed",{selectedDocuments:o.map(e=>({id:e.chunkId||(0,N.DO)(),source:e.source,content:e.content,snippet:e.snippet,relevanceScore:e.relevance_score,metadata:{page:e.page,chunkId:e.chunkId||(0,N.DO)(),fileType:e.metadata?.file_type||"unknown",...e.metadata}})),contextLength:u.length,contextPreview:u.substring(0,500),assemblyStrategy:"Relevance-based concatenation"}),console.log(`✅ RAG context created: ${u.length} characters`)):(k.H.updateContextAssemblyStep(a,"completed",{selectedDocuments:[],contextLength:0,contextPreview:"",assemblyStrategy:"No documents selected"}),console.log(`❌ No documents retrieved for query: "${r}"`))}catch(e){console.error("RAG retrieval error:",e),k.H.updateDocumentRetrievalStep(a,"error",void 0,e instanceof Error?e.message:"Unknown RAG error")}let p=/research\s+papers?|analyze.*papers?|paper.*analysis|document.*analysis|analyze.*research|study.*papers?/i.test(r);console.log(`🔍 RAG Context Debug:`,{hasContext:!!u,contextLength:u.length,sourcesCount:d.length,contextPreview:u.substring(0,200)+"..."});let m=u?`You are an intelligent AI assistant with access to the user's uploaded documents. 
       
       DOCUMENT CONTEXT:
       ${u}
       
       INSTRUCTIONS:
       - Use the document context above to answer questions when relevant
       - Always cite your sources when using information from documents (e.g., "According to [Source 1: filename.pdf]...")
       - If the user's question cannot be answered from the provided documents, clearly state this
       - Be conversational and helpful
       - Keep responses concise but informative
       - If no relevant documents are found, answer based on your general knowledge but mention that you don't have specific documents to reference
       - Today's date is ${new Date().toLocaleDateString()}
       
       You can also help with general tasks using the available tools when appropriate.`:`You are an intelligent AI assistant.
       
       INSTRUCTIONS:
       - Be helpful and conversational
       - Answer questions based on your knowledge
       - Keep responses concise but informative
       - You can help with various tasks using available tools
       - Today's date is ${new Date().toLocaleDateString()}
       
       SPECIAL HANDLING FOR RESEARCH PAPER REQUESTS:
       ${p?`- The user is asking about research papers or document analysis, but no documents are currently uploaded
       - Politely ask them to upload their research papers first using the Document Manager (📁 icon in the navbar)
       - Explain that once they upload their papers, you can help analyze them, extract key findings, compare studies, and answer specific questions about their content
       - Do not attempt to provide general information about research papers - focus on getting them to upload their specific documents for analysis`:"- If users want to upload documents for context, let them know they can use the document upload feature"}
       
       CONCURRENT OPERATIONS HANDLING:
       - If documents are currently being indexed, inform the user that some documents may still be processing
       - You can still answer questions based on already-indexed documents
       - Let users know that more comprehensive answers will be available once all documents are fully indexed`;console.log(`🤖 System prompt being sent to LLM:`,{hasRagContext:m.includes("DOCUMENT CONTEXT:"),promptLength:m.length,promptPreview:m.substring(0,300)+"..."});let g=o,h=m;if(u&&o.length>0){let e=o[o.length-1];if("user"===e.role){let t=d.map((e,t)=>`[${t+1}] ${e.source} (Relevance: ${(100*e.relevance_score).toFixed(1)}%)
Content: ${e.content.substring(0,150)}${e.content.length>150?"...":""}`).join("\n\n"),n=`CONTEXT FROM YOUR UPLOADED DOCUMENTS:

${u}

CITATION REFERENCE:
${t}

---

USER QUESTION: ${e.content}

Please answer using the document context provided above. When referencing information, use the citation format [1], [2], etc. corresponding to the sources listed in the citation reference.`;g=[...o.slice(0,-1),{...e,content:n}],h="You are an intelligent AI assistant. When provided with document context, use it to answer questions accurately and cite your sources using the numbered format [1], [2], etc. Be helpful and conversational.",console.log(`🔄 Injected RAG context with citations (${n.length} characters)`)}}return c&&k.H.updateResponseGenerationStep(a,"processing",{model:"gemini-1.5-flash",promptLength:h.length,contextLength:u.length}),Date.now(),(await (0,i.kP)({model:T,system:h,messages:g,experimental_providerMetadata:{ragSources:d.map((e,t)=>({id:`rag-${t+1}`,filename:e.source,snippet:e.content.substring(0,200)+(e.content.length>200?"...":""),relevanceScore:e.relevance_score,index:t+1,fullContent:e.content}))},tools:{searchDocuments:{description:"Search through the user's uploaded documents for specific information",parameters:l.Ry({query:l.Z_().describe("The search query to find relevant information in documents"),maxResults:l.Rx().optional().describe("Maximum number of results to return (default: 3)")}),execute:async({query:e,maxResults:t=3})=>{if(!s.user?.id)return{error:"User not authenticated"};try{let n=(0,A.vd)(),o=await n.retrieveDocuments(e,s.user.id,{maxDocs:t,threshold:.6});if(0===o.length)return{message:"No relevant documents found for this query.",results:[],query:e};return{query:e,results:o.map((e,t)=>({source:e.source,content:e.content.substring(0,500)+(e.content.length>500?"...":""),relevanceScore:e.relevance_score,index:t+1})),totalFound:o.length,citations:o.map((e,t)=>({id:e.chunkId||`${e.source}_${t}`,filename:e.source,snippet:e.snippet||e.content.substring(0,120)+"...",page:e.page,index:t+1}))}}catch(t){return console.error("Document search error:",t),{error:"Failed to search documents",query:e}}}},getWeather:{description:"Get the current weather at a location",parameters:l.Ry({latitude:l.Rx().describe("Latitude coordinate"),longitude:l.Rx().describe("Longitude coordinate")}),execute:async({latitude:e,longitude:t})=>{let n=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current=temperature_2m&hourly=temperature_2m&daily=sunrise,sunset&timezone=auto`);return await n.json()}}},onFinish:async({responseMessages:e})=>{if(c){Date.now();let t=e.map(e=>e.content).join("");k.H.updateResponseGenerationStep(a,"completed",{model:"gemini-1.5-flash",promptLength:h.length,contextLength:u.length,responseLength:t.length,tokenUsage:{prompt:Math.ceil(h.length/4),completion:Math.ceil(t.length/4),total:Math.ceil((h.length+t.length)/4)}}),k.H.completeSession(a,d.map(e=>({id:(0,N.DO)(),source:e.source,content:e.content,snippet:e.content.substring(0,120),relevanceScore:e.relevance_score,metadata:{chunkId:(0,N.DO)(),fileType:"unknown"}})))}if(s.user&&s.user.id)try{let n=e.map(e=>"assistant"===e.role&&d.length>0?{...e,experimental_attachments:[...e.experimental_attachments||[],{name:"rag-sources",contentType:"application/json",url:`data:application/json;base64,${Buffer.from(JSON.stringify(d)).toString("base64")}`}]}:e);await (0,E.l_)({id:t,messages:[...o,...n],userId:s.user.id})}catch(e){console.error("Failed to save chat")}},experimental_telemetry:{isEnabled:!0,functionId:"stream-text"}})).toDataStreamResponse({})}async function q(e){let{searchParams:t}=new URL(e.url),n=t.get("id");if(!n)return new Response("Not Found",{status:404});let s=await (0,D.I8)();if(!s||!s.user)return new Response("Unauthorized",{status:401});try{if((await (0,E.T)({id:n})).userId!==s.user.id)return new Response("Unauthorized",{status:401});return await (0,E.LT)({id:n}),new Response("Chat deleted",{status:200})}catch(e){return new Response("An error occurred while processing your request",{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/(chat)/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/(chat)/api/chat/route"},resolvedPagePath:"/Users/duy/Documents/build/rag/app/(chat)/api/chat/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:U,staticGenerationAsyncStorage:G,prerenderAsyncStorage:M,serverHooks:$}=_;function j(){return(0,a.patchFetch)({staticGenerationAsyncStorage:G,requestAsyncStorage:U,prerenderAsyncStorage:M})}},15914:(e,t,n)=>{n.d(t,{H:()=>o});class s{createSession(e,t,n){let s={sessionId:e,userId:t,query:n,timestamp:Date.now(),status:"active",steps:{queryEmbedding:{id:"query-embedding",name:"Query Embedding",status:"pending"},documentRetrieval:{id:"document-retrieval",name:"Document Retrieval",status:"pending"},contextAssembly:{id:"context-assembly",name:"Context Assembly",status:"pending"},responseGeneration:{id:"response-generation",name:"Response Generation",status:"pending"}},citations:[]};return this.sessions.set(e,s),this.emitEvent({type:"session_start",sessionId:e,data:s,timestamp:Date.now()}),s}updateQueryEmbeddingStep(e,t,n,s){let o=this.sessions.get(e);if(!o)return;let r=o.steps.queryEmbedding.startTime||Date.now(),a="completed"===t||"error"===t?Date.now():void 0;o.steps.queryEmbedding={...o.steps.queryEmbedding,status:t,startTime:o.steps.queryEmbedding.startTime||r,endTime:a,duration:a?a-r:void 0,data:n?{...o.steps.queryEmbedding.data,...n}:o.steps.queryEmbedding.data,error:s},this.emitEvent({type:"processing"===t?"step_start":"step_complete",sessionId:e,stepId:"queryEmbedding",data:o.steps.queryEmbedding,timestamp:Date.now()})}updateDocumentRetrievalStep(e,t,n,s){let o=this.sessions.get(e);if(!o)return;let r=o.steps.documentRetrieval.startTime||Date.now(),a="completed"===t||"error"===t?Date.now():void 0;o.steps.documentRetrieval={...o.steps.documentRetrieval,status:t,startTime:o.steps.documentRetrieval.startTime||r,endTime:a,duration:a?a-r:void 0,data:n?{...o.steps.documentRetrieval.data,...n}:o.steps.documentRetrieval.data,error:s},this.emitEvent({type:"processing"===t?"step_start":"step_complete",sessionId:e,stepId:"documentRetrieval",data:o.steps.documentRetrieval,timestamp:Date.now()})}updateContextAssemblyStep(e,t,n,s){let o=this.sessions.get(e);if(!o)return;let r=o.steps.contextAssembly.startTime||Date.now(),a="completed"===t||"error"===t?Date.now():void 0;o.steps.contextAssembly={...o.steps.contextAssembly,status:t,startTime:o.steps.contextAssembly.startTime||r,endTime:a,duration:a?a-r:void 0,data:n?{...o.steps.contextAssembly.data,...n}:o.steps.contextAssembly.data,error:s},this.emitEvent({type:"processing"===t?"step_start":"step_complete",sessionId:e,stepId:"contextAssembly",data:o.steps.contextAssembly,timestamp:Date.now()})}updateResponseGenerationStep(e,t,n,s){let o=this.sessions.get(e);if(!o)return;let r=o.steps.responseGeneration.startTime||Date.now(),a="completed"===t||"error"===t?Date.now():void 0;o.steps.responseGeneration={...o.steps.responseGeneration,status:t,startTime:o.steps.responseGeneration.startTime||r,endTime:a,duration:a?a-r:void 0,data:n?{...o.steps.responseGeneration.data,...n}:o.steps.responseGeneration.data,error:s},this.emitEvent({type:"processing"===t?"step_start":"step_complete",sessionId:e,stepId:"responseGeneration",data:o.steps.responseGeneration,timestamp:Date.now()})}completeSession(e,t=[]){let n=this.sessions.get(e);if(!n)return;let s=n.timestamp,o=Date.now()-s;n.status="completed",n.totalDuration=o,n.citations=t,this.emitEvent({type:"session_complete",sessionId:e,data:{totalDuration:o,citations:t},timestamp:Date.now()})}errorSession(e,t){let n=this.sessions.get(e);n&&(n.status="error",this.emitEvent({type:"error",sessionId:e,data:{error:t},timestamp:Date.now()}))}subscribe(e,t){return this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(t),()=>{let n=this.subscribers.get(e);n&&(n.delete(t),0===n.size&&this.subscribers.delete(e))}}emitEvent(e){let t=this.sessions.get(e.sessionId);if(!t)return;let n=this.subscribers.get(t.userId);n&&n.forEach(t=>{try{t(e)}catch(e){console.error("Error in RAG demonstration event callback:",e)}})}getSession(e){return this.sessions.get(e)}cleanup(){let e=Date.now()-36e5;for(let[t,n]of this.sessions.entries())n.timestamp<e&&this.sessions.delete(t)}getUserSessions(e){return Array.from(this.sessions.values()).filter(t=>t.userId===e)}constructor(){this.sessions=new Map,this.subscribers=new Map}}let o=new s;"undefined"!=typeof setInterval&&setInterval(()=>{o.cleanup()},6e5)},87930:(e,t,n)=>{n.d(t,{DO:()=>i,Ty:()=>l,cn:()=>a});var s=n(30006),o=n(57119),r=n(80106);function a(...e){return(0,r.m6)((0,o.W)(e))}function i(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();if("undefined"!=typeof crypto&&crypto.getRandomValues){let e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let t=Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}return console.warn("Using Math.random() for UUID generation - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function l(e){return e.reduce((e,t)=>{if("tool"===t.role)return function({toolMessage:e,messages:t}){return t.map(t=>t.toolInvocations?{...t,toolInvocations:t.toolInvocations.map(t=>{let n=e.content.find(e=>e.toolCallId===t.toolCallId);return n?{...t,state:"result",result:n.result}:t})}:t)}({toolMessage:t,messages:e});let n="",o=[];if("string"==typeof t.content)n=t.content;else if(Array.isArray(t.content))for(let e of t.content)"text"===e.type?n+=e.text:"tool-call"===e.type&&o.push({state:"call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args});return e.push({id:(0,s.Ox)(),role:t.role,content:n,toolInvocations:o,ragSources:t.experimental_attachments?.find(e=>"rag-sources"===e.name)?(()=>{try{let e=t.experimental_attachments.find(e=>"rag-sources"===e.name);if(e?.url.startsWith("data:application/json;base64,")){let t=e.url.split(",")[1],n=Buffer.from(t,"base64").toString("utf-8");return JSON.parse(n)}}catch(e){console.error("Error parsing RAG sources in convertToUIMessages:",e)}})():void 0}),e},[])}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),s=t.X(0,[615,503,80,536,400,463],()=>n(47658));module.exports=s})();